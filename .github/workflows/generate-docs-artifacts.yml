# This GitHub action can generate documentation artifacts for a release when a tag is created.
# Currently its set up to run on any tag that matches the pattern "v*" (ie. v0.1.0).

# Documentation artifacts generated by this can action also be generated manually, but it is
# encouraged to use the action on release events so that documentation stays up to date.
# Manual process: Requires Nodejs and NPM
# In the plugin root execute the `packer-docs-artifact` command
# > npx -p @hashicorp/packer-docs-artifacts generate
#
# The generated files will be placed under PLUGIN_ROOT/.doc-artifacts; this directory contains all the docs
# and respective navigation information needed for including the plugin docs under packer.io/docs/
#
# Merge the generated files to the default branch for the plugin repository (probably `main` or `master`)
#
# Once merged, you will need to open a one time pull-request against hashicorp/packer to register the plugin docs.
# This can be done by adding the block below for the respective plugins to the file website/data/docs-remote-navigation.js in the https://github.com/hashicorp/packer repository
# {
#    "title": "Scaffolding",
#    "path": "scaffolding",
#    "repo": "hashicorp/packer-plugin-scaffolding",
#    "branch": "main",
#    "artifaceDir": ".doc-artifacts"
#  }

name: generate-docs-artifacts
on:
  push:
    tags:
      - 'v*'
jobs:
  snapshot-docs-artifacts:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v2
      - name: Setup Node
        uses: actions/setup-node@v1
      - run:  npx -p @hashicorp/packer-docs-artifacts generate
      - name: Get Release Tag
        id: tag_details
        run: echo ::set-output name=TAG::${GITHUB_REF/refs\/tags\//}
        shell: bash
      - name: Create Pull Request with Generated Doc Artifacts
        uses: peter-evans/create-pull-request@v3
        with:
          # See Action inputs https://github.com/peter-evans/create-pull-request#action-inputs
          token: ${{ secrets.GITHUB_TOKEN }}
          # The base branch to open a pull-request against. By default the base branch matches
          # the checked out branch. If not the default branch it should be adjust to main or master.
          # see https://github.com/peter-evans/create-pull-request/blob/master/docs/concepts-guidelines.md#events-which-checkout-a-commit
          base: "main"
          # The name of the branch that will be automatically created for the generated pull-request.
          branch: "update-docs-artifacts-${{steps.tag_details.outputs.TAG}}"
          title: "Update generated docs artifact cache for ${{steps.tag_details.outputs.TAG}}"
          body: "Automated changes to update generated docs artifact cache for ${{steps.tag_details.outputs.TAG}}"
          commit-message: "plugin/docs: update generated docs artifact cache"
          # The committer name and email address in the format Display Name <email@address.com>.
          # Defaults to GitHub, you may need to change this in cases where committers must sign a CLA.
          # committer: "GitHub <noreply@github.com>"
          # Comment out the author field if you would like to change the author of the pull-request.
          # Defaults to the name of the user who triggered the event - created the tag.
          # author: ""
          # Comment out the labels field to automatically apply a common separated list of labels to the created pull-request.
          # labels
          delete-branch: true

